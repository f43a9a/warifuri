# ğŸ” Warifuri åŒ…æ‹¬çš„ãƒã‚°èª¿æŸ»è¨ˆç”»

## ğŸ¯ èª¿æŸ»ç›®çš„

ä»Šå›ã®ã‚¯ãƒ­ã‚¹ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¾å­˜è§£æ±ºãƒã‚°ã®ã‚ˆã†ãªåŸºæœ¬çš„ãƒ»æ§‹é€ çš„å•é¡Œã‚’ä½“ç³»çš„ã«ç™ºè¦‹ã—ã€ä¿®æ­£ã™ã‚‹ã“ã¨ã§ã€warifuriã®å …ç‰¢æ€§ã¨ä¿¡é ¼æ€§ã‚’å‘ä¸Šã•ã›ã‚‹ã€‚

## ğŸš¨ ç™ºè¦‹ã•ã‚ŒãŸæ·±åˆ»ãªå•é¡Œ

### 1. **å‹å®‰å…¨æ€§ã®ç ´ç¶»** (Critical)

#### å•é¡Œè©³ç´°
```python
# src/warifuri/cli/commands/template.py:30
workspace_path = ctx.workspace_path  # Path | None
templates_dir = workspace_path / "templates"  # Type error!
```

**å½±éŸ¿**: `ctx.workspace_path`ãŒ`None`ã®å ´åˆã€å®Ÿè¡Œæ™‚ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹å¯èƒ½æ€§

#### å½±éŸ¿ãƒ•ã‚¡ã‚¤ãƒ«
- `src/warifuri/cli/commands/template.py`
- `src/warifuri/cli/commands/validate.py`
- `src/warifuri/cli/commands/show.py`
- `src/warifuri/cli/commands/run.py`
- `src/warifuri/cli/commands/mark_done.py`
- `src/warifuri/cli/commands/list.py`
- `src/warifuri/cli/commands/issue.py`
- `src/warifuri/cli/commands/init.py`
- `src/warifuri/cli/commands/graph.py`

### 2. **ä¾‹å¤–å‡¦ç†ã®ä¸é©åˆ‡ãªæŠ‘åˆ¶** (High)

#### å•é¡Œãƒ‘ã‚¿ãƒ¼ãƒ³
```python
# ç¦æ­¢ãƒ‘ã‚¿ãƒ¼ãƒ³1: ç„¡è¨€ã§å¤±æ•—ã‚’æ¡ã‚Šã¤ã¶ã™
try:
    templates = [d.name for d in templates_dir.iterdir() if d.is_dir()]
except Exception:  # å…·ä½“çš„ãªä¾‹å¤–ã‚’æŒ‡å®šã›ãš
    templates = []  # é™ã‹ã«ç©ºãƒªã‚¹ãƒˆã‚’è¿”ã™

# ç¦æ­¢ãƒ‘ã‚¿ãƒ¼ãƒ³2: Gitã‚¨ãƒ©ãƒ¼ã‚’éš è”½
except Exception:
    return None  # ã‚¨ãƒ©ãƒ¼ã®åŸå› ãŒåˆ†ã‹ã‚‰ãªã„
```

**å½±éŸ¿**: ãƒ‡ãƒãƒƒã‚°ãŒå›°é›£ã«ãªã‚Šã€ã‚µã‚¤ãƒ¬ãƒ³ãƒˆãªæ©Ÿèƒ½åœæ­¢ãŒç™ºç”Ÿ

### 3. **ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹å‡¦ç†ã®è„†å¼±æ€§** (Medium)

#### å•é¡Œãƒ‘ã‚¿ãƒ¼ãƒ³
```python
# å±é™ºãªãƒ‘ã‚¹æ“ä½œ
clean_path = input_file.replace("../", "")  # å˜ç´”ãªæ–‡å­—åˆ—ç½®æ›
while clean_path.startswith("../"):         # ç„¡é™ãƒ«ãƒ¼ãƒ—ã®å¯èƒ½æ€§
    clean_path = clean_path[3:]             # ç¯„å›²å¤–ã‚¢ã‚¯ã‚»ã‚¹ãƒªã‚¹ã‚¯
```

**å½±éŸ¿**: ãƒ‘ã‚¹ãƒ»ãƒˆãƒ©ãƒãƒ¼ã‚µãƒ«æ”»æ’ƒã€äºˆæœŸã—ãªã„ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ã‚¯ã‚»ã‚¹

### 4. **ç«¶åˆçŠ¶æ…‹ã¨åŸå­æ€§ã®æ¬ å¦‚** (Medium)

#### å•é¡Œãƒ‘ã‚¿ãƒ¼ãƒ³
```python
# done.mdã®ç«¶åˆçŠ¶æ…‹
if not (task.path / "done.md").exists():  # ãƒã‚§ãƒƒã‚¯
    # åˆ¥ãƒ—ãƒ­ã‚»ã‚¹ãŒã“ã“ã§done.mdã‚’ä½œæˆã™ã‚‹å¯èƒ½æ€§
    execute_task(task)                    # å®Ÿè¡Œ
    create_done_file(task)               # ä½œæˆ
```

**å½±éŸ¿**: åŒä¸€ã‚¿ã‚¹ã‚¯ã®é‡è¤‡å®Ÿè¡Œã€ãƒ‡ãƒ¼ã‚¿ç«¶åˆ

## ğŸ“‹ è©³ç´°èª¿æŸ»è¨ˆç”»

### Phase 1: Critical Issues (å³åº§å¯¾å¿œ)

#### 1.1 å‹å®‰å…¨æ€§ã®å®Œå…¨ä¿®å¾©
- [ ] `Context.workspace_path`ã®Nullå®‰å…¨æ€§ç¢ºä¿
- [ ] ã™ã¹ã¦ã®CLIã‚³ãƒãƒ³ãƒ‰ã§`workspace_path`ãŒ`None`ã®å ´åˆã®é©åˆ‡ãªã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
- [ ] `mypy --strict`ã®å®Œå…¨é€šé

#### 1.2 ä¾‹å¤–å‡¦ç†ã®æ¨™æº–åŒ–
- [ ] å…·ä½“çš„ãªä¾‹å¤–ã‚¯ãƒ©ã‚¹ã®æŒ‡å®š
- [ ] ãƒ­ã‚°å‡ºåŠ›ã®è¿½åŠ 
- [ ] ã‚µã‚¤ãƒ¬ãƒ³ãƒˆå¤±æ•—ã®æ’é™¤

### Phase 2: High Priority (1é€±é–“ä»¥å†…)

#### 2.1 ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹å‡¦ç†ã®å¼·åŒ–
- [ ] `pathlib.Path.resolve()`ã«ã‚ˆã‚‹æ­£è¦åŒ–
- [ ] ãƒ‘ã‚¹ãƒ»ãƒˆãƒ©ãƒãƒ¼ã‚µãƒ«æ”»æ’ƒå¯¾ç­–
- [ ] Windows/Linuxäº’æ›æ€§ç¢ºä¿

#### 2.2 ä¸¦è¡Œæ€§ãƒ»ç«¶åˆçŠ¶æ…‹å¯¾ç­–
- [ ] ãƒ•ã‚¡ã‚¤ãƒ«ãƒ­ãƒƒã‚¯æ©Ÿæ§‹ã®å°å…¥
- [ ] åŸå­æ€§æ“ä½œã®å®Ÿè£…
- [ ] ãƒ—ãƒ­ã‚»ã‚¹é–“ç«¶åˆã®æ¤œå‡ºãƒ»å¯¾ç­–

#### 2.3 ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–
- [ ] å…¥åŠ›å€¤æ¤œè¨¼ã®çµ±ä¸€
- [ ] æ¨©é™ãƒã‚§ãƒƒã‚¯æ©Ÿèƒ½
- [ ] ã‚µãƒ³ãƒ‰ãƒœãƒƒã‚¯ã‚¹å¼·åŒ–

### Phase 3: Medium Priority (2é€±é–“ä»¥å†…)

#### 3.1 ã‚¨ãƒ©ãƒ¼å‡¦ç†ã®æ”¹å–„
- [ ] æ§‹é€ åŒ–ãƒ­ã‚°ã®å°å…¥
- [ ] ã‚¨ãƒ©ãƒ¼å›å¾©æ©Ÿèƒ½
- [ ] ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼ãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸

#### 3.2 ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å•é¡Œ
- [ ] å¤§è¦æ¨¡ä¾å­˜ã‚°ãƒ©ãƒ•ã§ã®æ€§èƒ½ãƒ†ã‚¹ãƒˆ
- [ ] ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯æ¤œå‡º
- [ ] I/Oæœ€é©åŒ–

#### 3.3 ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸æ‹¡å¼µ
- [ ] ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹ã®ç¶²ç¾…
- [ ] çµ±åˆãƒ†ã‚¹ãƒˆå¼·åŒ–
- [ ] æ€§èƒ½å›å¸°ãƒ†ã‚¹ãƒˆ

## ğŸ› ï¸ ä¿®æ­£æ‰‹é †ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ

### å‹å®‰å…¨æ€§ä¿®æ­£ãƒ‘ã‚¿ãƒ¼ãƒ³
```python
# Before (å±é™º)
def command(ctx: Context) -> None:
    workspace_path = ctx.workspace_path
    result = workspace_path / "file"  # Type error!

# After (å®‰å…¨)
def command(ctx: Context) -> None:
    workspace_path = ctx.ensure_workspace_path()  # raises if None
    result = workspace_path / "file"  # Type safe!
```

### ä¾‹å¤–å‡¦ç†ä¿®æ­£ãƒ‘ã‚¿ãƒ¼ãƒ³
```python
# Before (å±é™º)
try:
    risky_operation()
except Exception:
    return default_value

# After (å®‰å…¨)
try:
    risky_operation()
except SpecificError as e:
    logger.warning("Operation failed: %s", e)
    return default_value
except AnotherError as e:
    logger.error("Critical error: %s", e)
    raise
```

### ãƒ•ã‚¡ã‚¤ãƒ«æ“ä½œä¿®æ­£ãƒ‘ã‚¿ãƒ¼ãƒ³
```python
# Before (è„†å¼±)
clean_path = input_file.replace("../", "")

# After (å®‰å…¨)
try:
    resolved_path = (base_path / input_file).resolve()
    if not resolved_path.is_relative_to(base_path):
        raise SecurityError("Path traversal detected")
    return resolved_path
except (OSError, ValueError) as e:
    raise PathResolutionError(f"Invalid path: {input_file}") from e
```

## ğŸ”„ ç¶™ç¶šçš„å“è³ªä¿è¨¼

### è‡ªå‹•åŒ–ã•ã‚ŒãŸãƒã‚§ãƒƒã‚¯
- [ ] pre-commit hookã§ã®å‹ãƒã‚§ãƒƒã‚¯å¼·åŒ–
- [ ] CI/CDã§ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³
- [ ] ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯
- [ ] ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯æ¤œå‡º

### ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼åŸºæº–
- [ ] å‹å®‰å…¨æ€§ã®å¿…é ˆç¢ºä¿
- [ ] ä¾‹å¤–å‡¦ç†ã®æ¨™æº–ãƒ‘ã‚¿ãƒ¼ãƒ³éµå®ˆ
- [ ] ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹é©ç”¨
- [ ] ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸è¦ä»¶

## ğŸ“Š é€²æ—ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°

### Critical Issues (0/2 å®Œäº†)
- [ ] å‹å®‰å…¨æ€§ä¿®å¾©
- [ ] ä¾‹å¤–å‡¦ç†æ¨™æº–åŒ–

### High Priority (0/4 å®Œäº†)
- [ ] ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹å‡¦ç†å¼·åŒ–
- [ ] ä¸¦è¡Œæ€§å¯¾ç­–
- [ ] ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–
- [ ] ã‚¨ãƒ©ãƒ¼å‡¦ç†æ”¹å–„

### Medium Priority (0/3 å®Œäº†)
- [ ] ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–
- [ ] ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸æ‹¡å¼µ
- [ ] ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ•´å‚™

## ğŸ¯ æœ€çµ‚ç›®æ¨™

**å …ç‰¢æ€§**: å‹å®‰å…¨æ€§100%ã€ä¾‹å¤–å‡¦ç†ã®æ¨™æº–åŒ–
**ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£**: ãƒ‘ã‚¹ãƒ»ãƒˆãƒ©ãƒãƒ¼ã‚µãƒ«å¯¾ç­–ã€å…¥åŠ›å€¤æ¤œè¨¼
**ä¿¡é ¼æ€§**: ç«¶åˆçŠ¶æ…‹å¯¾ç­–ã€åŸå­æ€§ä¿è¨¼
**ä¿å®ˆæ€§**: æ§‹é€ åŒ–ãƒ­ã‚°ã€æ˜ç¢ºãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸

ã“ã®èª¿æŸ»ã«ã‚ˆã‚Šã€warifuriã¯æ¬¡ã®ãƒ¬ãƒ™ãƒ«ã®å“è³ªã¨ä¿¡é ¼æ€§ã‚’é”æˆã™ã‚‹ã€‚
